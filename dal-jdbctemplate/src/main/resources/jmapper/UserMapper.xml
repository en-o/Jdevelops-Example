<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    示例 XML Mapper 文件
    演示如何使用 XML 定义 SQL 语句

    namespace: 对应接口的全限定名
-->
<mapper namespace="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.UserMapper">

    <!-- SQL 片段，可以被 include 引用 -->
    <sql id="baseColumns">
        id, username, email, age, status, created_at
    </sql>

    <!-- 简单查询 -->
    <select id="findById" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        WHERE id = #{id}
    </select>

    <!-- 动态 SQL - 使用 if 标签 -->
    <select id="findUsers" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="username != null and username != ''">
                AND username LIKE #{username}
            </if>
            <if test="email != null and email != ''">
                AND email = #{email}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="minAge != null">
                AND age >= #{minAge}
            </if>
            <if test="maxAge != null">
                AND age &lt;= #{maxAge}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 使用 foreach 标签 -->
    <select id="findByIds" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        WHERE id IN
        <foreach collection="ids" item="itemId" open="(" separator="," close=")">
            #{itemId}
        </foreach>
    </select>

    <!-- 插入操作 -->
    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO users_mapper (username, email, age, status, created_at)
        VALUES (#{username}, #{email}, #{age}, #{status}, NOW())
    </insert>

    <!-- 批量插入 -->
    <insert id="batchInsert">
        INSERT INTO users_mapper (username, email, age, status, created_at)
        VALUES
        <foreach collection="list" item="user" separator=",">
            (#{user.username}, #{user.email}, #{user.age}, #{user.status}, NOW())
        </foreach>
    </insert>

    <!-- 批量插入 - 通过 UserQuery 对象的 users 属性 -->
    <!-- 场景：参数是对象，对象中包含 List<Bean> 属性 -->
    <!-- collection="users" 访问 UserQuery.users 属性 -->
    <insert id="batchInsertFromQuery">
        INSERT INTO users_mapper (username, email, age, status, created_at)
        VALUES
        <foreach collection="users" item="user" separator=",">
            (#{user.username}, #{user.email}, #{user.age}, #{user.status}, NOW())
        </foreach>
    </insert>

    <!-- 更新操作 - 使用 set 标签 -->
    <update id="updateUser">
        UPDATE users_mapper
        <set>
            <if test="username != null">
                username = #{username},
            </if>
            <if test="email != null">
                email = #{email},
            </if>
            <if test="age != null">
                age = #{age},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除操作 -->
    <delete id="deleteById">
        DELETE FROM users_mapper WHERE id = #{id}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteByIds">
        DELETE FROM users_mapper
        WHERE id IN
        <foreach collection="ids" item="itemId" open="(" separator="," close=")">
            #{itemId}
        </foreach>
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteAll">
        DELETE FROM users_mapper;
        ALTER TABLE users_mapper AUTO_INCREMENT = 1;
    </delete>


    <!-- 统计查询 -->
    <select id="countUsers" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM users_mapper
        <where>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>

    <!-- 分页查询 -->
    <select id="findUsersPage" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 复杂查询 - 多条件组合 -->
    <select id="findUsersAdvanced" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="keyword != null and keyword != ''">
                AND (username LIKE CONCAT('%', #{keyword}, '%')
                OR email LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="statusList != null and statusList.size() > 0">
                AND status IN
                <foreach collection="statusList" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="startDate != null">
                AND created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND created_at &lt;= #{endDate}
            </if>
        </where>
        ORDER BY
        <if test="orderBy != null and orderBy != ''">
            #{orderBy}
        </if>
        <if test="orderBy == null or orderBy == ''">
            created_at DESC
        </if>
    </select>

    <!-- 分页查询 SQL 片段(通用查询条件) -->
    <sql id="pageWhereConditions">
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="email != null and email != ''">
                AND email = #{email}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="minAge != null">
                AND age >= #{minAge}
            </if>
            <if test="maxAge != null">
                AND age &lt;= #{maxAge}
            </if>
        </where>
    </sql>

    <!-- 分页查询用户(带条件) -->
    <select id="findUsersPageWithTotal" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="arg0.username != null and arg0.username != ''">
                AND username LIKE CONCAT('%', #{arg0.username}, '%')
            </if>
            <if test="arg0.email != null and arg0.email != ''">
                AND email = #{arg0.email}
            </if>
            <if test="arg0.status != null">
                AND status = #{arg0.status}
            </if>
            <if test="arg0.minAge != null">
                AND age >= #{arg0.minAge}
            </if>
            <if test="arg0.maxAge != null">
                AND age &lt;= #{arg0.maxAge}
            </if>
        </where>
        ORDER BY
        <if test="arg1.orderBySql != null and arg1.orderBySql != ''">
            ${arg1.orderBySql}
        </if>
        <if test="arg1.orderBySql == null or arg1.orderBySql == ''">
            created_at DESC
        </if>
        LIMIT #{arg1.pageSize} OFFSET #{arg1.offset}
    </select>

    <!-- 统计符合条件的用户总数 -->
    <select id="countUsersByCondition" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM users_mapper
        <include refid="pageWhereConditions"/>
    </select>

    <!-- 测试用: 无条件统计总数 -->
    <select id="countUsersTotal" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM users_mapper
    </select>
    <!-- 框架内置分页查询（自动） -->
    <select id="findUsersPageAuto" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="arg0.username != null and arg0.username != ''">
                AND username LIKE CONCAT('%', #{arg0.username}, '%')
            </if>
            <if test="arg0.email != null and arg0.email != ''">
                AND email = #{arg0.email}
            </if>
            <if test="arg0.status != null">
                AND status = #{arg0.status}
            </if>
            <if test="arg0.minAge != null">
                AND age >= #{arg0.minAge}
            </if>
            <if test="arg0.maxAge != null">
                AND age &lt;= #{arg0.maxAge}
            </if>
        </where>
        ORDER BY
        <if test="arg1.orderBySql != null and arg1.orderBySql != ''">
            ${arg1.orderBySql}
        </if>
        <if test="arg1.orderBySql == null or arg1.orderBySql == ''">
            created_at DESC
        </if>
        LIMIT #{arg1.pageSize} OFFSET #{arg1.offset}
    </select>

    <!-- ========================================= -->
    <!-- 特殊符号处理测试用例                         -->
    <!-- 演示如何在 XML 中正确处理 <、>、& 等特殊符号  -->
    <!-- ========================================= -->

    <!-- 测试1: 使用 XML 实体转义处理特殊符号 -->
    <select id="findUsersWithLessThan" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 使用实体转义：&lt; 表示 < -->
            <if test="maxAge != null">
                AND age &lt; #{maxAge}
            </if>
            <!-- 使用实体转义：&gt; 表示 > -->
            <if test="minAge != null">
                AND age &gt; #{minAge}
            </if>
            <!-- 使用实体转义：&lt;= 表示 <= -->
            <if test="maxAgeEqual != null">
                AND age &lt;= #{maxAgeEqual}
            </if>
            <!-- 使用实体转义：&gt;= 表示 >= -->
            <if test="minAgeEqual != null">
                AND age &gt;= #{minAgeEqual}
            </if>
        </where>
        ORDER BY age ASC
    </select>

    <!-- 测试2: 使用 CDATA 区块处理特殊符号 -->
    <select id="findUsersWithCDATA" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="maxAge != null">
                <![CDATA[
                AND age < #{maxAge}
                ]]>
            </if>
            <if test="minAge != null">
                <![CDATA[
                AND age > #{minAge}
                ]]>
            </if>
            <if test="maxAgeEqual != null">
                <![CDATA[
                AND age <= #{maxAgeEqual}
                ]]>
            </if>
            <if test="minAgeEqual != null">
                <![CDATA[
                AND age >= #{minAgeEqual}
                ]]>
            </if>
        </where>
        ORDER BY age ASC
    </select>

    <!-- 测试3: BETWEEN 范围查询 -->
    <select id="findUsersBetweenAge" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- BETWEEN 语法 -->
            <if test="minAge != null and maxAge != null">
                AND age BETWEEN #{minAge} AND #{maxAge}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY age ASC
    </select>

    <!-- 测试4: BETWEEN 日期范围查询（使用 CDATA） -->
    <select id="findUsersBetweenDate" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <if test="startDate != null and endDate != null">
                <![CDATA[
                AND created_at BETWEEN #{startDate} AND #{endDate}
                ]]>
            </if>
            <if test="startDate != null and endDate == null">
                <![CDATA[
                AND created_at >= #{startDate}
                ]]>
            </if>
            <if test="startDate == null and endDate != null">
                <![CDATA[
                AND created_at <= #{endDate}
                ]]>
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试5: 复杂条件组合（AND + OR + NOT） -->
    <select id="findUsersComplexConditions" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 组合条件：年龄在范围内 -->
            <if test="minAge != null and maxAge != null">
                <![CDATA[
                AND (age >= #{minAge} AND age <= #{maxAge})
                ]]>
            </if>
            <!-- OR 条件：状态为1或2 -->
            <if test="status1 != null and status2 != null">
                AND (status = #{status1} OR status = #{status2})
            </if>
            <!-- NOT 条件：排除某个用户名 -->
            <if test="excludeUsername != null">
                AND username != #{excludeUsername}
            </if>
            <!-- NOT IN 条件：排除某些ID -->
            <if test="excludeIds != null and excludeIds.size() > 0">
                AND id NOT IN
                <foreach collection="excludeIds" item="excludeId" open="(" separator="," close=")">
                    #{excludeId}
                </foreach>
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试6: LIKE 模糊查询（多种方式） -->
    <select id="findUsersWithLike" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 方式1: 使用 CONCAT 函数 -->
            <if test="usernamePrefix != null">
                AND username LIKE CONCAT(#{usernamePrefix}, '%')
            </if>
            <!-- 方式2: 使用 CONCAT 实现全模糊匹配 -->
            <if test="usernameLike != null">
                AND username LIKE CONCAT('%', #{usernameLike}, '%')
            </if>
            <!-- 方式3: 邮箱后缀匹配 -->
            <if test="emailSuffix != null">
                AND email LIKE CONCAT('%', #{emailSuffix})
            </if>
        </where>
        ORDER BY username ASC
    </select>

    <!-- 测试7: IN 查询（多种数据类型） -->
    <select id="findUsersInConditions" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- IN 条件：ID列表 -->
            <if test="ids != null and ids.size() > 0">
                AND id IN
                <foreach collection="ids" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <!-- IN 条件：状态列表 -->
            <if test="statusList != null and statusList.size() > 0">
                AND status IN
                <foreach collection="statusList" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <!-- IN 条件：用户名列表 -->
            <if test="usernames != null and usernames.size() > 0">
                AND username IN
                <foreach collection="usernames" item="username" open="(" separator="," close=")">
                    #{username}
                </foreach>
            </if>
        </where>
        ORDER BY id ASC
    </select>

    <!-- 测试8: NULL 值处理 -->
    <select id="findUsersWithNull" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- IS NULL 条件 -->
            <if test="emailIsNull != null and emailIsNull == true">
                AND email IS NULL
            </if>
            <!-- IS NOT NULL 条件 -->
            <if test="emailIsNotNull != null and emailIsNotNull == true">
                AND email IS NOT NULL
            </if>
            <!-- COALESCE 函数处理 NULL 值 -->
            <if test="defaultAge != null">
                <![CDATA[
                AND COALESCE(age, #{defaultAge}) >= #{defaultAge}
                ]]>
            </if>
        </where>
        ORDER BY id ASC
    </select>

    <!-- 测试9: 混合使用实体转义和 CDATA -->
    <select id="findUsersMixedSpecialChars" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 使用实体转义 -->
            <if test="status != null">
                AND status &lt;&gt; #{status}
            </if>
            <!-- 使用 CDATA -->
            <if test="minAge != null and maxAge != null">
                <![CDATA[
                AND (age > #{minAge} AND age < #{maxAge})
                ]]>
            </if>
            <!-- 嵌套条件 -->
            <if test="keyword != null">
                AND (
                    username LIKE CONCAT('%', #{keyword}, '%')
                    OR email LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试10: 数学运算和比较 -->
    <select id="findUsersWithMath" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 数学运算：年龄大于某个值的2倍 -->
            <if test="ageMultiplier != null">
                <![CDATA[
                AND age > (#{ageMultiplier} * 2)
                ]]>
            </if>
            <!-- 数学运算：年龄在某个范围的百分比内 -->
            <if test="ageBase != null and agePercent != null">
                <![CDATA[
                AND age >= (#{ageBase} * #{agePercent} / 100)
                ]]>
            </if>
        </where>
        ORDER BY age DESC
    </select>

    <!-- ========================================= -->
    <!-- 枚举和 Record 类型方法调用测试                 -->
    <!-- 测试修复：支持枚举的 name()、ordinal() 等方法   -->
    <!-- ========================================= -->

    <!-- 测试11: 枚举 name() 方法调用 -->
    <select id="findUsersByPlatform" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试枚举的 name() 方法调用 -->
            <if test="platform != null and platform.name() != 'NONE'">
                AND username LIKE '%test%'
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试12: 枚举 ordinal() 方法调用 -->
    <select id="findUsersByPlatformOrdinal" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试枚举的 ordinal() 方法调用 -->
            <if test="platform != null and platform.ordinal() > 0">
                AND username LIKE '%test%'
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试13: 多参数形式的枚举 name() 方法调用 (arg0.platform.name()) -->
    <select id="findUsersByPlatformWithArg0" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试 arg0.platform.name() 形式的枚举方法调用 -->
            <if test="arg0.platform != null and arg0.platform.name() != 'NONE'">
                AND username LIKE '%test%'
            </if>
            <if test="arg0.status != null">
                AND status = #{arg0.status}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{arg1}
    </select>

    <!-- ========================================= -->
    <!-- 多值枚举测试                               -->
    <!-- 测试修复：支持枚举的 getCode()、getName() 等方法 -->
    <!-- ========================================= -->

    <!-- 测试14: 多值枚举 getCode() 方法调用 -->
    <select id="findUsersByUserStatusCode" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试多值枚举的 getCode() 方法调用 -->
            <if test="userStatus != null and userStatus.getCode() == 1">
                AND status = #{userStatus.getCode()}
            </if>
            <!-- 也可以测试不等于 -->
            <if test="userStatus != null and userStatus.getCode() != 0">
                AND username LIKE '%test%'
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试15: 多值枚举 getName() 方法调用 -->
    <select id="findUsersByUserStatusName" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试多值枚举的 getName() 方法调用 -->
            <if test="userStatus != null and userStatus.getName() == '已激活'">
                AND status = 1
            </if>
            <if test="userStatus != null and userStatus.getName() != '未激活'">
                AND username LIKE '%test%'
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试16: 多值枚举 getDescription() 方法调用 -->
    <select id="findUsersByUserStatusDescription" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试多值枚举的 getDescription() 方法调用 -->
            <if test="userStatus != null and userStatus.getDescription() != null">
                AND status = #{userStatus.getCode()}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试17: 多值枚举复杂条件组合 -->
    <select id="findUsersByUserStatusComplex" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 组合使用多值枚举的多个方法 -->
            <if test="userStatus != null">
                <!-- 使用 getCode() 方法 -->
                <if test="userStatus.getCode() > 0">
                    <![CDATA[
                    AND status >= #{userStatus.getCode()}
                    ]]>
                </if>
                <!-- 使用 name() 方法（枚举名称） -->
                <if test="userStatus.name() != 'DELETED'">
                    AND username LIKE '%test%'
                </if>
                <!-- 使用 getName() 方法（自定义名称字段） -->
                <if test="userStatus.getName() != null and userStatus.getName() != ''">
                    AND status != 9
                </if>
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 测试18: 多参数形式的多值枚举方法调用 (arg0.userStatus.getCode()) -->
    <select id="findUsersByUserStatusWithArg0" resultType="cn.tannn.demo.jdevelops.daljdbctemplate.mapper.example.UserMapperEntity">
        SELECT
        <include refid="baseColumns"/>
        FROM users_mapper
        <where>
            <!-- 测试 arg0.userStatus.getCode() 形式的多值枚举方法调用 -->
            <if test="arg0.userStatus != null and arg0.userStatus.getCode() == 1">
                AND status = #{arg0.userStatus.getCode()}
            </if>
            <!-- 测试 arg0.userStatus.getName() -->
            <if test="arg0.userStatus != null and arg0.userStatus.getName() == '已激活'">
                AND username LIKE '%test%'
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{arg1}
    </select>

</mapper>
